{% extends 'texas/base.html.twig' %}

{% block title %}Texas Hold'em{% endblock %}

{% block main %}
    <h1>Texas Hold'em</h1>

    <div class="game-info">
        <h2>Pot:  {{ pot }}</h2>
        <h3>Current Bet: {{ game.getPotManager().getCurrentBet() }}</h3> <!-- Display the current bet -->
        <h3>Current Phase: 
        {% set currentStage = game.stageManager.getCurrentStage() %}
        {% if currentStage == 0 %}
            About to deal flop...
        {% elseif currentStage == 1 %}
            About to deal turn...
        {% elseif currentStage == 2 %}
            About to deal river...
        {% elseif currentStage == 3 %}
            Showdown...
        {% elseif currentStage == 4 %}
            Announcing winner...
        {% else %}
            Unknown phase
        {% endif %}
        </h3>
    </div>
    {% if isGameOver %}
        <div class="winner-announcement">
            <h2>Round Over</h2>
            <h1>Winner:</h1>
            {% for winner in winners %}
                <p>{{ winner.getName }} wins  {{ pot }} chips and now has {{ winner.getChips() }} chips in total.</p>
            {% endfor %}
        </div>
    {% endif %}

    <div class="community-cards-container">
        <div class="community-cards">
            <h2>Community Cards</h2>
            <div class="cards">
                {% for card in game.getCommunityCardManager().getCommunityCards() %}
                    <img class="card-image" src="{{ asset(card.getAsString()) }}" alt="Card">
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="players">
        {% for player in game.getPlayers() %}
            <div class="player">
                <h2>{{ player.getName() }} ({{ player.getRole() | capitalize }})</h2>
                {% set action = game.getActions()[player.getName()] | default('No action yet') %}
                {% if player.isFolded() %}
                    <p>Folded</p>
                {% else %}
                    <div class="cards">
                        {% for card in player.getHand() %}
                            <img class="card-image" src="{{ asset(card.getAsString()) }}" alt="Card">
                        {% endfor %}
                    </div>
                {% endif %}
                <p>Chips: {{ player.getChips() }}</p>
                <p>Took action: {{ action }}</p>
            </div>
            {# Dump the evaluated hand and rank #}
            {% set bestHand = game.getHandEvaluator().getBestHand(player.getHand() | merge(game.getCommunityCardManager().getCommunityCards())) %}
            <p>Best Hand: {{ bestHand.rank }}</p>
            <p>Values: {{ bestHand.values|join(', ') }}</p>
        {% endfor %}
    </div>

    <h2>Debug Information:</h2>
{{ dump(game.getActions()) }}
    <ul>
        <li>Current Stage: {{ game.stageManager.getCurrentStage() }}</li>
        <li>Remaining Active Players: {{ game.countActivePlayers() }}</li>
    </ul>

    <div class="actions">
        {% if isGameOver %}
            {% if game.getPlayers()[0].getChips() >= 20 %}
                <form method="post" action="{{ path('proj_new_round') }}">
                    <button type="submit">Start New Round</button>
                </form>
            {% endif %}
            <a href="{{ path('proj_start') }}">Start New Game</a>
        {% else %}
        <h2>Your Actions</h2>
            {% set currentBet = game.getPotManager().getCurrentBet() %}
            {% set playerBet = game.getPlayers()[0].getCurrentBet() %}
            {% set humanPlayer = game.getPlayers()[0] %}
            
            {% if humanPlayer.getChips() > 0 %}
                <div class="action-buttons">
                    {% if playerBet < currentBet %}
                        <!-- If the player's current bet is less than the current required bet, show only Call, Fold, Raise, All-In -->
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="call">
                            <button type="submit">Call</button>
                        </form>
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="fold">
                            <button type="submit">Fold</button>
                        </form>
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="raise">
                            <input type="number" id="raiseAmount" name="raiseAmount" min="1" max="{{ minChips }}" required>
                            <button type="submit">Raise</button>
                        </form>
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="all-in">
                            <button type="submit">All-In</button>
                        </form>
                    {% else %}
                        <!-- If the player has matched the current bet, allow checking -->
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="check">
                            <button type="submit">Check</button>
                        </form>
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="raise">
                            <input type="number" id="raiseAmount" name="raiseAmount" min="1" max="{{ minChips }}" required>
                            <button type="submit">Raise</button>
                        </form>
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="fold">
                            <button type="submit">Fold</button>
                        </form>
                        <form method="post" action="{{ path('proj_play') }}">
                            <input type="hidden" name="action" value="all-in">
                            <button type="submit">All-In</button>
                        </form>
                    {% endif %}
                </div>
            {% else %}
                <p>You are all-in. Waiting for other players...</p>
            {% endif %}
        {% endif %}
    </div>
{% endblock %}